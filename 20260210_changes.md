# Security Hardening — Full Pass (15 Items)

**Date:** 2026-02-10
**Branch:** `feat/security-hardening`
**Base:** `main` @ `c5a0845`

---

## Phase 1: Hardcoded Filter Defaults (Items 5, 6, 8, 13)

### New File: `src/agent/hardcoded_filters.rs`
- Compiled-in deny constants that config can extend but never remove
- **Bash deny substrings:** `.device_key`, `.security_audit.jsonl`, `rm -rf /`, `mkfs`, fork bomb (`:(){ :|:& };:`), `chmod 777`
- **Bash deny patterns:** `\bsudo\b`, `curl.*\|.*sh`, `wget.*\|.*sh`, `curl.*\|.*python`
- **Web_fetch deny substrings:** `file://`, `localhost`, `0.0.0.0`, `169.254.169.254`, `[::1]`
- **Web_fetch deny patterns:** Private IP ranges (`10.x`, `172.16-31.x`, `192.168.x`, `127.x`)

### Modified: `src/agent/tool_filters.rs`
- Add `merge_hardcoded(deny_substrings, deny_patterns) -> Self` method to `CompiledToolFilter`
- Deduplicates entries before merging

### Modified: `src/agent/tools.rs` — `create_default_tools()`
- After `compile_filter_for()`, call `.merge_hardcoded()` with appropriate constants for `bash` and `web_fetch`

---

## Phase 2: Enforcement (Items 1, 7, 3)

### Item 1 — Bash Block, Not Warn
**File:** `src/agent/tools.rs` (BashTool)
- Change `check_bash_command()` result handling: return `Err(...)` when `strict_policy` is true instead of appending warning and continuing
- Add `strict_policy: bool` field to `BashTool` struct
- Pass `strict_policy` from config at construction time

### Item 7 — Symlink Resolution
**File:** `src/agent/tools.rs`
- Add `resolve_real_path(path: &str) -> Result<PathBuf>` function
- Expands tilde via `shellexpand::tilde()`
- Resolves symlinks via `fs::canonicalize()` (canonicalize parent for new files)
- Called before all protected-file checks and path-scope checks in file tools

### Item 3 — Path Scoping for File Tools
**Config:** `security.allowed_directories: Vec<String>` (default: `[]` = unrestricted)
- Add `check_path_allowed(real_path, allowed_dirs) -> Result<()>` function
- Pre-canonicalize allowed dirs at startup
- Apply to `ReadFileTool`, `WriteFileTool`, `EditFileTool` execute methods
- Flow: tilde expand -> resolve symlinks -> check path scope -> check protected files -> filter check -> I/O
- Add `allowed_directories: Vec<PathBuf>` field to each file tool struct

---

## Phase 3: Post-Exec Integrity (Item 2)

**File:** `src/agent/tools.rs` — `BashTool::execute()`
- After bash execution completes, check if command string references workspace path or `LocalGPT.md`
- If so, re-verify HMAC via `load_and_verify_policy()`
- On tamper detection:
  - **Strict mode:** audit log + return error
  - **Permissive mode:** audit log + warning appended to output
- Add `workspace_path: PathBuf` field to `BashTool` struct

---

## Phase 4: Network Security (Items 4, 15)

### Item 4 — HTTP API Auth
**New file:** `src/server/auth.rs`
- `ensure_api_token(state_dir) -> String`: generate 32-byte random token on first run
- Token stored at `~/.localgpt/.api_token` with `0600` permissions
- Axum middleware: validate `Authorization: Bearer <token>` on all `/api/*` routes
- Skip auth for `/health` endpoint
- Add `api_token: String` to `AppState`
- Print token file path on startup
- **Config:** `server.require_auth: bool` (default: `true`)

### Item 15 — Telegram Session Expiry
**Config:** `telegram.session_ttl: Option<String>` (e.g. `"24h"`, `"7d"`)
- In `handle_message()`, check `paired_at` timestamp against configured TTL
- If expired: clear pairing, trigger re-pair flow
- Add `paired_at: Option<i64>` to pairing data if not already present

---

## Phase 5: Operational Limits (Items 9, 11, 10)

### Item 9 — Tool Output Size Limits
**Config:** `tools.max_output_bytes: HashMap<String, usize>` (default: `{"bash": 102400}`)
- In `execute_tool()`, truncate output exceeding per-tool limit
- Append `[truncated: N bytes total]` marker when truncating

### Item 11 — Rate Limiting
**Config fields:**
- `tools.max_tool_calls_per_turn: usize` (default: `50`)
- `tools.max_consecutive_errors: usize` (default: `5`)
- Add `tool_call_count: usize` and `consecutive_error_count: usize` to `Agent` struct
- Reset counters per `chat()` call
- Apply limits in both `handle_response()` and `stream_with_tool_loop()`
- Replace hardcoded `max_tool_iterations = 10` with configurable value

### Item 10 — Env Var Protection
**Config:** `security.env_deny_patterns: Vec<String>` (default: `["*_KEY", "*_SECRET", "*_TOKEN", "*_PASSWORD", "*_CREDENTIALS"]`)
- In `BashTool::execute()`, filter `std::env::vars()` through deny patterns before spawning subprocess
- Use simple glob matching (`*_KEY` -> `ends_with("_KEY")`)
- Add `env_deny_patterns: Vec<String>` to `BashTool` struct

---

## Phase 6: Advanced (Items 14, 12)

### Item 14 — Secret Scanning
**New file:** `src/agent/secret_scanner.rs`
- Regex patterns for:
  - AWS keys (`AKIA...`)
  - GitHub PATs (`ghp_...`, `gho_...`, `ghs_...`)
  - Private keys (`-----BEGIN.*PRIVATE KEY-----`)
  - Anthropic keys (`sk-ant-...`)
  - OpenAI keys (`sk-...`)
  - Generic high-entropy strings
- `redact_secrets(text) -> (String, Vec<SecretMatch>)` function
- Integrate in `execute_tool()` post-truncation, pre-sanitization

### Item 12 — Confirmation Flow (CLI-first)
**Config:** `tools.require_confirmation_patterns: Vec<String>`
- Add `ToolApprovalCallback` trait with `fn approve(tool_name, args) -> bool`
- Agent stores `Option<Arc<dyn ToolApprovalCallback>>`
- Before executing tools matching patterns, call callback
- CLI provides stdin-based implementation
- Telegram/HTTP deferred to future (always approve or always deny based on config)

---

## New Audit Actions

**File:** `src/security/audit.rs`
- Add to `AuditAction` enum:
  - `RateLimitExceeded`
  - `PathDenied`
  - `SecretRedacted`
  - `SessionAborted`

---

## Config Changes Summary

### `SecurityConfig`
| Field | Type | Default | Purpose |
|-------|------|---------|---------|
| `strict_policy` | `bool` | `false` | (existing) Hard-exit on tamper |
| `allowed_directories` | `Vec<String>` | `[]` | Path scoping for file tools |
| `env_deny_patterns` | `Vec<String>` | `["*_KEY", ...]` | Filter env vars from bash subprocess |

### `ToolsConfig`
| Field | Type | Default | Purpose |
|-------|------|---------|---------|
| `max_output_bytes` | `HashMap<String, usize>` | `{"bash": 102400}` | Per-tool output truncation |
| `max_tool_calls_per_turn` | `usize` | `50` | Rate limit per chat turn |
| `max_consecutive_errors` | `usize` | `5` | Error streak limit |
| `require_confirmation_patterns` | `Vec<String>` | `[]` | Patterns requiring user approval |

### `ServerConfig`
| Field | Type | Default | Purpose |
|-------|------|---------|---------|
| `require_auth` | `bool` | `true` | Bearer token auth on /api/* |

### `TelegramConfig`
| Field | Type | Default | Purpose |
|-------|------|---------|---------|
| `session_ttl` | `Option<String>` | `None` | Session expiry duration |

---

## New Files

| File | Purpose |
|------|---------|
| `src/agent/hardcoded_filters.rs` | Compiled-in deny defaults for bash/web_fetch |
| `src/agent/secret_scanner.rs` | Secret detection and redaction |
| `src/server/auth.rs` | Bearer token generation/validation middleware |

---

## Modified Files

| File | Changes |
|------|---------|
| `src/agent/tool_filters.rs` | `merge_hardcoded()` method |
| `src/agent/tools.rs` | Bash blocking, symlink resolution, path scoping, post-exec integrity, env var filtering, output limits, hardcoded filter wiring |
| `src/agent/mod.rs` | Rate limiting counters, output truncation, secret scanning, approval callback, export new modules |
| `src/config/mod.rs` | New fields on SecurityConfig, ToolsConfig, ServerConfig, TelegramConfig |
| `src/security/audit.rs` | New AuditAction variants |
| `src/server/http.rs` | Auth middleware integration |
| `src/server/telegram.rs` | Session expiry check |

---

## Verification Checklist

- [ ] `cargo build` compiles clean
- [ ] `cargo test` — existing tests pass
- [ ] `cargo clippy` — no new warnings
- [ ] `bash` tool with `sudo ls` -> blocked by hardcoded deny
- [ ] `read_file ~/.ssh/id_rsa` -> blocked by path scoping (if configured)
- [ ] `web_fetch file:///etc/passwd` -> blocked by egress defaults
- [ ] `bash echo > LocalGPT.md` -> blocked + audit entry
- [ ] Symlink to `.device_key` then `write_file` -> blocked after canonicalization
- [ ] HTTP `/api/chat` without Bearer token -> 401
- [ ] `localgpt security audit` -> new event types visible
- [ ] Env var `echo $ANTHROPIC_API_KEY` via bash -> stripped from subprocess env
